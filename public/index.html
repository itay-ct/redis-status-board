<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redis Status Board</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Top Bar */
    .top-bar {
      background: #2d2d2d;
      border-bottom: 1px solid #404040;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .top-bar h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #fff;
      margin-right: auto;
    }

    .connection-form {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      max-width: 800px;
    }

    .connection-form input {
      background: #1a1a1a;
      border: 1px solid #404040;
      color: #e0e0e0;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .connection-form input:focus {
      border-color: #0066cc;
    }

    .connection-form input::placeholder {
      color: #666;
    }

    #url { flex: 2; min-width: 200px; }
    #username { flex: 1; min-width: 100px; }

    .password-wrapper {
      flex: 1;
      min-width: 100px;
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-wrapper input {
      width: 100%;
      padding-right: 2.5rem;
    }

    .password-toggle {
      position: absolute;
      right: 0.5rem;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }

    .password-toggle:hover {
      color: #999;
      background: transparent;
    }

    .password-toggle svg {
      width: 18px;
      height: 18px;
    }

    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 500;
    }

    button:hover {
      background: #0052a3;
    }

    button:active {
      background: #004080;
    }

    .btn-secondary {
      background: #404040;
    }

    .btn-secondary:hover {
      background: #4d4d4d;
    }

    .logout-btn {
      background: transparent;
      color: #999;
      border: 1px solid #404040;
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
      margin-left: auto;
    }

    .logout-btn:hover {
      background: #333;
      color: #ccc;
      border-color: #555;
    }

    .logout-btn:active {
      background: #2a2a2a;
    }

    /* Notification Popup */
    .notification-popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2d2d2d;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      will-change: transform, opacity;
      backface-visibility: hidden;
    }

    .notification-popup.status-red {
      border-color: #ef4444;
    }

    .notification-popup.status-green {
      border-color: #10b981;
    }

    .notification-popup.status-purple {
      border-color: #a855f7;
    }

    .notification-popup.hiding {
      animation: slideOut 0.3s ease-out forwards;
    }

    @keyframes slideIn {
      from {
        transform: translateX(450px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(450px);
        opacity: 0;
      }
    }

    .notification-popup .message {
      color: #e0e0e0;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    /* User Status Bar */
    .user-status-bar {
      background: #252525;
      border-bottom: 1px solid #404040;
      padding: 0.75rem 1.5rem;
      display: none;
      align-items: center;
      gap: 1rem;
    }

    .user-status-bar.visible {
      display: flex;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: auto;
    }

    .user-info .username {
      font-weight: 600;
      color: #fff;
    }

    .status-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-selector label {
      font-size: 0.875rem;
      color: #999;
    }

    .status-selector select {
      background: #1a1a1a;
      border: 1px solid #404040;
      color: #e0e0e0;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
      cursor: pointer;
      outline: none;
    }

    .status-selector select:focus {
      border-color: #0066cc;
    }

    .status-selector input {
      background: #1a1a1a;
      border: 1px solid #404040;
      color: #e0e0e0;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
      outline: none;
      min-width: 200px;
    }

    .status-selector input:focus {
      border-color: #0066cc;
    }

    .status-selector input::placeholder {
      color: #666;
    }

    /* Main Content */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* Main Layout - Split View */
    .main-layout {
      display: none;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      height: calc(100vh - 140px);
      padding: 1.5rem;
      transition: grid-template-columns 0.3s ease;
    }

    .main-layout.visible {
      display: grid;
    }

    .main-layout.map-collapsed {
      grid-template-columns: 1fr 40px;
      padding-right: 0;
      gap: 0;
    }

    .left-panel {
      overflow-y: auto;
      overflow-x: hidden;
    }

    .right-panel {
      position: relative;
      overflow: hidden;
      background: #2d2d2d;
      border-radius: 8px;
      border: 1px solid #404040;
      transition: all 0.3s ease;
    }

    .right-panel.collapsed {
      border-radius: 8px 0 0 8px;
    }

    .users-section {
      display: none;
    }

    .users-section.visible {
      display: block;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .section-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #fff;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #2d2d2d;
      border-radius: 8px;
      overflow: hidden;
    }

    thead {
      background: #252525;
    }

    th {
      text-align: left;
      padding: 0.75rem 1rem;
      font-weight: 600;
      font-size: 0.875rem;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 0.75rem 1rem;
      border-top: 1px solid #404040;
      font-size: 0.875rem;
    }

    tbody tr {
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: #333;
    }

    /* Status Colors */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-red .status-dot { background: #ef4444; }
    .status-green .status-dot { background: #10b981; }
    .status-purple .status-dot { background: #a855f7; }

    .status-red { color: #ef4444; }
    .status-green { color: #10b981; }
    .status-purple { color: #a855f7; }

    /* Error Message */
    .error-message {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 0.75rem 1rem;
      border-radius: 4px;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }

    .error-message.visible {
      display: block;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #666;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Map Styles */
    .map-container {
      width: 100%;
      height: 100%;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #2d2d2d;
      transition: opacity 0.3s ease;
    }

    .right-panel.collapsed .map-container {
      opacity: 0;
      pointer-events: none;
    }

    #map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    .map-container.pin-mode #map {
      cursor: crosshair !important;
    }

    .map-toggle-btn {
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      z-index: 1000;
      background: #1a1a1a;
      border: 1px solid #404040;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .map-toggle-btn:hover {
      background: #2d2d2d;
      border-color: #666;
    }

    .right-panel.collapsed .map-toggle-btn {
      left: 50%;
      transform: translate(-50%, -50%);
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    /* Custom Leaflet marker styles */
    .custom-marker-icon {
      background: transparent;
      border: none;
    }

    .marker-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* No transform - positioning handled by iconAnchor */
    }

    .marker-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #2d2d2d;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .marker-circle.status-red {
      background: #ef4444;
    }

    .marker-circle.status-green {
      background: #10b981;
    }

    .marker-circle.status-purple {
      background: #a855f7;
    }

    .marker-circle svg {
      width: 24px;
      height: 24px;
      stroke: #fff;
      fill: none;
      stroke-width: 2;
      position: relative;
      z-index: 10;
    }

    .marker-label {
      margin-top: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
    }

    .update-location-btn {
      background: #6c3fb5;
      margin-left: 0.5rem;
      transition: opacity 0.3s ease;
    }

    .update-location-btn:hover {
      background: #5a3399;
    }

    .update-location-btn.active {
      background: #ff6b35;
    }

    .update-location-btn.active:hover {
      background: #e55a2b;
    }

    body.map-collapsed .update-location-btn {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Top Bar with Connection Form -->
  <div class="top-bar" id="topBar">
    <h1>üî¥ Redis Status Board</h1>
    <div class="connection-form" id="connectionForm">
      <input id="url" placeholder="redis://host:port or just host:port" type="text">
      <input id="username" placeholder="username" type="text">
      <div class="password-wrapper">
        <input id="password" placeholder="password" type="password">
        <button type="button" class="password-toggle" id="passwordToggle" title="Show password">
          <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <svg id="eyeOffIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display: none;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
          </svg>
        </button>
      </div>
      <button id="connectBtn">Connect</button>
    </div>
    <button class="logout-btn" id="logoutBtn" style="display: none;">Log out</button>
  </div>

  <!-- User Status Bar (shown after connection) -->
  <div class="user-status-bar" id="userStatusBar">
    <div class="user-info">
      <span>Logged in as:</span>
      <span class="username" id="currentUser"></span>
    </div>
    <div class="status-selector">
      <label for="myStatus">Your status:</label>
      <select id="myStatus">
        <option value="red">üî¥ Busy</option>
        <option value="green">üü¢ Available</option>
        <option value="purple">üü£ Away</option>
      </select>
      <input type="text" id="statusMessage" placeholder="What are you working on?" maxlength="100">
      <button id="updateStatusBtn">Update</button>
      <button class="update-location-btn" id="updateLocationBtn" title="Update location on map">üìç Location</button>
    </div>
  </div>

  <!-- Error Message -->
  <div class="container">
    <div class="error-message" id="error"></div>
  </div>

  <!-- Main Layout - Split View -->
  <div class="main-layout" id="mainLayout">
    <!-- Left Panel - User List -->
    <div class="left-panel">
      <div class="users-section visible">
        <div class="section-header">
          <h2>Team Status</h2>
          <button class="btn-secondary" id="refreshBtn">üîÑ Refresh</button>
        </div>
        <table id="usersTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Status</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Right Panel - Map -->
    <div class="right-panel" id="rightPanel">
      <button class="map-toggle-btn" id="mapToggleBtn">‚ñ∂</button>
      <div class="map-container" id="mapContainer">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <script>
    const connectBtn = document.getElementById('connectBtn');
    const urlInput = document.getElementById('url');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('passwordToggle');
    const eyeIcon = document.getElementById('eyeIcon');
    const eyeOffIcon = document.getElementById('eyeOffIcon');
    const errorDiv = document.getElementById('error');
    const userStatusBar = document.getElementById('userStatusBar');
    const usersSection = document.getElementById('usersSection');
    const currentUserSpan = document.getElementById('currentUser');
    const myStatusSelect = document.getElementById('myStatus');
    const statusMessageInput = document.getElementById('statusMessage');
    const updateStatusBtn = document.getElementById('updateStatusBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const usersTableBody = document.querySelector('#usersTable tbody');
    const connectionForm = document.getElementById('connectionForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const mainLayout = document.getElementById('mainLayout');
    const updateLocationBtn = document.getElementById('updateLocationBtn');
    const mapContainer = document.getElementById('mapContainer');
    const rightPanel = document.getElementById('rightPanel');
    const mapToggleBtn = document.getElementById('mapToggleBtn');

    let conn = {
      url: null,
      username: null,
      password: null,
      prefix: null,
      myUsername: null
    };

    const STORAGE_KEY = 'redisStatusBoard_credentials';
    const MAP_STATE_KEY = 'redisStatusBoard_mapCollapsed';
    let eventSource = null;
    let pinMode = false;
    let pendingLocation = null;
    let map = null;
    let userMarkers = {}; // Store markers by username

    // ============================================================================
    // MAP INITIALIZATION
    // ============================================================================

    function initializeMap() {
      console.log('[initializeMap] Initializing Leaflet map');

      // Israel bounds: approximately 29.5¬∞N to 33.3¬∞N, 34.2¬∞E to 35.9¬∞E
      const israelCenter = [31.5, 35.0]; // Center of Israel
      const israelBounds = [
        [29.5, 34.2], // Southwest
        [33.3, 35.9]  // Northeast
      ];

      // Initialize map
      map = L.map('map', {
        center: israelCenter,
        zoom: 8,
        minZoom: 7,
        maxZoom: 10,
        maxBounds: israelBounds,
        maxBoundsViscosity: 1.0,
        zoomControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        touchZoom: false
      });

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Handle map clicks for location pinning
      map.on('click', (e) => {
        console.log(`[map.click] Click detected, pinMode=${pinMode}`);
        console.log(`[map.click] Coordinates: ${e.latlng.lat}, ${e.latlng.lng}`);

        if (!pinMode) {
          console.log('[map.click] Not in pin mode, ignoring click');
          return;
        }

        pendingLocation = {
          latitude: e.latlng.lat,
          longitude: e.latlng.lng
        };
        console.log('[map.click] Pending location set:', pendingLocation);

        pinMode = false;
        mapContainer.classList.remove('pin-mode');
        updateLocationBtn.classList.remove('active');
        updateLocationBtn.textContent = 'üìç Location';

        updateMyStatusWithLocation();
      });

      console.log('[initializeMap] Map initialized successfully');
    }

    // ============================================================================
    // CREDENTIAL STORAGE (localStorage)
    // ============================================================================

    function saveCredentials(url, username, password) {
      const credentials = { url, username, password };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(credentials));
    }

    function loadCredentials() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          return null;
        }
      }
      return null;
    }

    function saveMapState(collapsed) {
      localStorage.setItem(MAP_STATE_KEY, collapsed ? 'true' : 'false');
    }

    function loadMapState() {
      const stored = localStorage.getItem(MAP_STATE_KEY);
      return stored === 'true';
    }

    function toggleMapVisibility() {
      const isCollapsed = rightPanel.classList.toggle('collapsed');
      mainLayout.classList.toggle('map-collapsed', isCollapsed);
      document.body.classList.toggle('map-collapsed', isCollapsed);
      mapToggleBtn.textContent = isCollapsed ? '‚óÄ' : '‚ñ∂';
      saveMapState(isCollapsed);
      if (!isCollapsed && map) {
        setTimeout(() => map.invalidateSize(), 300);
      }
    }

    function clearCredentials() {
      localStorage.removeItem(STORAGE_KEY);
    }

    // ============================================================================
    // NOTIFICATION POPUP
    // ============================================================================

    function showNotification(message) {
      const existing = document.querySelector('.notification-popup');
      if (existing) {
        existing.remove();
      }

      const notification = document.createElement('div');
      notification.className = 'notification-popup';

      if (message.includes('Away')) {
        notification.classList.add('status-purple');
      } else if (message.includes('Available')) {
        notification.classList.add('status-green');
      } else if (message.includes('Busy')) {
        notification.classList.add('status-red');
      }

      notification.innerHTML = `<div class="message">${message}</div>`;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('hiding');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // ============================================================================
    // SERVER-SENT EVENTS (SSE)
    // ============================================================================

    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource('/api/updates');

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('[SSE] Received:', data);

        if (data.type === 'update') {
          showNotification(data.message);
          refreshUsers();
        }
      };

      eventSource.onerror = (err) => {
        console.error('[SSE] Error:', err);
      };

      console.log('[SSE] Connected to updates stream');
    }

    function disconnectSSE() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
        console.log('[SSE] Disconnected from updates stream');
      }
    }

    // ============================================================================
    // UI STATE MANAGEMENT
    // ============================================================================

    function showLoggedInState() {
      connectionForm.style.display = 'none';
      logoutBtn.style.display = 'block';
      userStatusBar.classList.add('visible');
      mainLayout.classList.add('visible');

      // Initialize map if not already initialized
      if (!map) {
        initializeMap();
      }

      connectSSE();
    }

    function showLoggedOutState() {
      connectionForm.style.display = 'flex';
      logoutBtn.style.display = 'none';
      userStatusBar.classList.remove('visible');
      mainLayout.classList.remove('visible');
      usersTableBody.innerHTML = '';
      clearMapMarkers();
      currentUserSpan.textContent = '';
      statusMessageInput.value = '';
      myStatusSelect.value = 'green';
      disconnectSSE();
    }

    function logout() {
      clearCredentials();
      conn = { url: null, username: null, password: null, prefix: null, myUsername: null };
      showLoggedOutState();
      showError('');
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================

    // Password visibility toggle
    passwordToggle.addEventListener('click', () => {
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      eyeIcon.style.display = isPassword ? 'none' : 'block';
      eyeOffIcon.style.display = isPassword ? 'block' : 'none';
      passwordToggle.title = isPassword ? 'Hide password' : 'Show password';
    });

    // Logout button
    logoutBtn.addEventListener('click', logout);

    // Map toggle button
    mapToggleBtn.addEventListener('click', toggleMapVisibility);

    // Normalize Redis URL
    function normalizeRedisUrl(url) {
      url = url.trim();
      // If it doesn't start with redis://, add it
      if (!url.startsWith('redis://') && !url.startsWith('rediss://')) {
        url = 'redis://' + url;
      }
      return url;
    }

    function showError(msg) {
      if (msg) {
        errorDiv.textContent = msg;
        errorDiv.classList.add('visible');
      } else {
        errorDiv.textContent = '';
        errorDiv.classList.remove('visible');
      }
    }

    async function postJSON(path, body) {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        throw new Error(data.error || 'Request failed');
      }
      return data;
    }

    async function connect(autoLogin = false) {
      showError('');

      const rawUrl = urlInput.value.trim();
      const normalizedUrl = normalizeRedisUrl(rawUrl);

      conn = {
        url: normalizedUrl,
        username: usernameInput.value.trim(),
        password: passwordInput.value
      };

      if (!rawUrl || !conn.username || !conn.password) {
        if (!autoLogin) {
          showError('Please fill in all fields.');
        }
        return;
      }

      try {
        if (!autoLogin) {
          connectBtn.textContent = 'Connecting...';
          connectBtn.disabled = true;
        }

        const result = await postJSON('/api/connect-test', {
          url: conn.url,
          username: conn.username,
          password: conn.password
        });

        // Save credentials on successful connection
        saveCredentials(conn.url, conn.username, conn.password);

        // Store prefix and myUsername from server response
        conn.prefix = result.prefix;
        conn.myUsername = result.myUsername;

        currentUserSpan.textContent = conn.username;

        // Populate current status and message if they exist
        if (result.currentStatus) {
          myStatusSelect.value = result.currentStatus.status || 'green';
          statusMessageInput.value = result.currentStatus.message || '';
        }

        showLoggedInState();

        await refreshUsers();

        if (!autoLogin) {
          connectBtn.textContent = 'Connected ‚úì';
          setTimeout(() => {
            connectBtn.textContent = 'Connect';
            connectBtn.disabled = false;
          }, 2000);
        }
      } catch (err) {
        console.error(err);
        if (!autoLogin) {
          showError('Connection failed: ' + err.message);
          connectBtn.textContent = 'Connect';
          connectBtn.disabled = false;
        } else {
          // Auto-login failed, clear invalid credentials
          clearCredentials();
        }
      }
    }

    function getStatusEmoji(status) {
      switch(status) {
        case 'red': return 'üî¥';
        case 'green': return 'üü¢';
        case 'purple': return 'üü£';
        default: return '‚ö™';
      }
    }

    function getStatusText(status) {
      switch(status) {
        case 'red': return 'Busy';
        case 'green': return 'Available';
        case 'purple': return 'Away';
        default: return 'Unknown';
      }
    }

    async function refreshUsers() {
      try {
        // Fetch user list (without locations)
        const data = await postJSON('/api/list-users', {});

        usersTableBody.innerHTML = '';

        if (data.users.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 3;
          td.style.textAlign = 'center';
          td.style.color = '#666';
          td.style.padding = '2rem';
          td.textContent = 'No users found';
          tr.appendChild(td);
          usersTableBody.appendChild(tr);
          return;
        }

        data.users.forEach(user => {
          const tr = document.createElement('tr');

          // Username column
          const tdUser = document.createElement('td');
          tdUser.textContent = user.username;
          tdUser.style.fontWeight = '500';
          tr.appendChild(tdUser);

          // Status column
          const tdStatus = document.createElement('td');
          const statusDiv = document.createElement('div');
          statusDiv.className = 'status-indicator status-' + user.status;
          statusDiv.innerHTML = `<span>${getStatusEmoji(user.status)} ${getStatusText(user.status)}</span>`;
          tdStatus.appendChild(statusDiv);
          tr.appendChild(tdStatus);

          // Message column
          const tdMessage = document.createElement('td');
          if (user.message) {
            // Create icon element - use icon from user data or default to 'message-circle'
            const iconSpan = document.createElement('i');
            const iconName = user.icon || 'message-circle';
            iconSpan.setAttribute('data-lucide', iconName);
            iconSpan.style.width = '24px';
            iconSpan.style.height = '24px';
            iconSpan.style.marginRight = '8px';
            iconSpan.style.verticalAlign = 'middle';
            iconSpan.style.display = 'inline-block';

            // Create text span
            const textSpan = document.createElement('span');
            textSpan.textContent = user.message;
            textSpan.style.verticalAlign = 'middle';

            tdMessage.appendChild(iconSpan);
            tdMessage.appendChild(textSpan);
            tdMessage.style.color = '#ccc';

            // Initialize the icon after adding to DOM
            setTimeout(() => lucide.createIcons(), 0);
          } else {
            tdMessage.textContent = '‚Äî';
            tdMessage.style.color = '#666';
          }
          tr.appendChild(tdMessage);

          usersTableBody.appendChild(tr);
        });

        // Fetch users with locations for map (separate call)
        await refreshMapMarkers();
      } catch (err) {
        console.error(err);
        showError('Failed to load users: ' + err.message);
      }
    }

    async function refreshMapMarkers() {
      try {
        console.log('[refreshMapMarkers] Fetching users with locations');

        clearMapMarkers();

        const data = await postJSON('/api/users-on-map', {});

        console.log(`[refreshMapMarkers] Received ${data.users.length} users with locations`);

        data.users.forEach(user => {
          if (user.longitude && user.latitude) {
            addMapMarker(user);
          }
        });
      } catch (err) {
        // Silently ignore "No such index" error (expected before index is created)
        if (err.message && err.message.includes('No such index')) {
          console.log('[refreshMapMarkers] Index not created yet - this is expected on first run');
          return;
        }

        console.error('[refreshMapMarkers] Error:', err);
        // Don't show error to user - map markers are optional
      }
    }

    // ============================================================================
    // MAP FUNCTIONS
    // ============================================================================

    function addMapMarker(user) {
      if (!map) {
        console.log('[addMapMarker] Map not initialized yet');
        return;
      }

      if (!user.longitude || !user.latitude) {
        console.log(`[addMapMarker] User ${user.username} has no location`);
        return;
      }

      console.log(`[addMapMarker] Adding marker for ${user.username} at ${user.latitude}, ${user.longitude}`);

      // Remove existing marker if any
      if (userMarkers[user.username]) {
        map.removeLayer(userMarkers[user.username]);
      }

      // Create custom marker HTML
      const markerHtml = `
        <div class="marker-content">
          <div class="marker-circle status-${user.status || 'green'}">
            <i data-lucide="${user.icon || 'circle'}"></i>
          </div>
          <div class="marker-label">${user.username}</div>
        </div>
      `;

      // Create custom icon
      // iconAnchor points to the center of the circle (20px from left, 20px from top)
      // This makes the circle center exactly on the clicked location
      const customIcon = L.divIcon({
        html: markerHtml,
        className: 'custom-marker-icon',
        iconSize: [40, 60],
        iconAnchor: [20, 20]  // Center of the 40px circle
      });

      // Create marker
      const marker = L.marker([user.latitude, user.longitude], {
        icon: customIcon
      }).addTo(map);

      // Add popup with message
      if (user.message) {
        marker.bindPopup(`<strong>${user.username}</strong><br>${user.message}`);
      }

      // Store marker reference
      userMarkers[user.username] = marker;

      // Initialize Lucide icons
      setTimeout(() => lucide.createIcons(), 0);
    }

    function clearMapMarkers() {
      console.log('[clearMapMarkers] Clearing all markers');
      Object.values(userMarkers).forEach(marker => {
        if (map) {
          map.removeLayer(marker);
        }
      });
      userMarkers = {};
    }

    function togglePinMode() {
      pinMode = !pinMode;
      console.log(`[togglePinMode] Pin mode: ${pinMode}`);

      if (pinMode) {
        mapContainer.classList.add('pin-mode');
        updateLocationBtn.classList.add('active');
        updateLocationBtn.textContent = 'üìç Click Map';
        console.log('[togglePinMode] Map is now in pin mode - click to set location');
      } else {
        mapContainer.classList.remove('pin-mode');
        updateLocationBtn.classList.remove('active');
        updateLocationBtn.textContent = 'üìç Location';
        // Don't clear pendingLocation here - it will be cleared after update
        console.log('[togglePinMode] Exited pin mode (pendingLocation preserved)');
      }
    }

    // Map click handler is now in initializeMap() function

    // Update location button
    updateLocationBtn.addEventListener('click', () => {
      console.log('[updateLocationBtn.click] Location button clicked');
      togglePinMode();
    });

    async function updateMyStatusWithLocation() {
      console.log('[updateMyStatusWithLocation] Called with pendingLocation:', pendingLocation);

      if (!pendingLocation) {
        console.log('[updateMyStatusWithLocation] No pending location, aborting');
        return;
      }

      try {
        updateStatusBtn.textContent = 'Updating...';
        updateStatusBtn.disabled = true;

        const payload = {
          myUsername: conn.myUsername,
          prefix: conn.prefix,
          status: myStatusSelect.value,
          message: statusMessageInput.value.trim(),
          longitude: pendingLocation.longitude,
          latitude: pendingLocation.latitude
        };

        console.log('[updateMyStatusWithLocation] Sending payload:', payload);

        const response = await postJSON('/api/update-status', payload);
        console.log('[updateMyStatusWithLocation] Response:', response);

        pendingLocation = null;
        console.log('[updateMyStatusWithLocation] Cleared pending location');

        await refreshUsers();
        console.log('[updateMyStatusWithLocation] Refreshed users');

        updateStatusBtn.textContent = 'Updated ‚úì';
        setTimeout(() => {
          updateStatusBtn.textContent = 'Update';
          updateStatusBtn.disabled = false;
        }, 1500);
      } catch (err) {
        console.error('[updateMyStatusWithLocation] ERROR:', err);
        showError('Failed to update status: ' + err.message);
        updateStatusBtn.textContent = 'Update';
        updateStatusBtn.disabled = false;
      }
    }

    async function updateMyStatus() {
      try {
        updateStatusBtn.textContent = 'Updating...';
        updateStatusBtn.disabled = true;

        await postJSON('/api/update-status', {
          myUsername: conn.myUsername,
          prefix: conn.prefix,
          status: myStatusSelect.value,
          message: statusMessageInput.value.trim()
        });

        await refreshUsers();

        updateStatusBtn.textContent = 'Updated ‚úì';
        setTimeout(() => {
          updateStatusBtn.textContent = 'Update';
          updateStatusBtn.disabled = false;
        }, 1500);
      } catch (err) {
        console.error(err);
        showError('Failed to update status: ' + err.message);
        updateStatusBtn.textContent = 'Update';
        updateStatusBtn.disabled = false;
      }
    }

    // Auto-update status when selection changes
    myStatusSelect.addEventListener('change', updateMyStatus);

    // Update on Enter key in message input
    statusMessageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        updateMyStatus();
      }
    });

    // Enter key support
    [urlInput, usernameInput, passwordInput].forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          connect();
        }
      });
    });

    connectBtn.addEventListener('click', () => connect(false));
    refreshBtn.addEventListener('click', refreshUsers);
    updateStatusBtn.addEventListener('click', updateMyStatus);

    // ============================================================================
    // AUTO-LOGIN ON PAGE LOAD
    // ============================================================================

    (function init() {
      const mapCollapsed = loadMapState();
      if (mapCollapsed) {
        rightPanel.classList.add('collapsed');
        mainLayout.classList.add('map-collapsed');
        document.body.classList.add('map-collapsed');
        mapToggleBtn.textContent = '‚óÄ';
      }

      const credentials = loadCredentials();
      if (credentials) {
        urlInput.value = credentials.url;
        usernameInput.value = credentials.username;
        passwordInput.value = credentials.password;
        connect(true);
      }
    })();

    // ============================================================================
    // INITIALIZE LUCIDE ICONS
    // ============================================================================

    // Initialize Lucide icons on page load
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>
</html>